<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Panasonic Phúc Lợi - Command Center 30km</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --pana-blue: #005696; --pana-red: #e60012; --dark: #333; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; background: #eee; overflow: hidden; }
        
        /* Sidebar trái: Danh sách */
        #sidebar-left { flex: 0 0 350px; background: white; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000; }
        
        /* Sidebar phải: Dashboard & Filter */
        #sidebar-right { flex: 0 0 300px; background: #f8f9fa; border-left: 1px solid #ddd; display: flex; flex-direction: column; padding: 15px; z-index: 1000; overflow-y: auto;}
        
        #map { flex: 1; height: 100%; }

        .header { background: var(--pana-blue); color: white; padding: 15px; text-align: center; }
        .filter-section { margin-bottom: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .filter-title { font-weight: bold; font-size: 14px; margin-bottom: 10px; display: block; color: var(--pana-blue); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        select { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 13px; }
        
        .project-card { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }
        .project-card:hover { background: #f0f7ff; }
        .project-card.active { border-left: 5px solid var(--pana-red); background: #f0f7ff; }

        .stat-card { background: var(--pana-blue); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
        .stat-num { font-size: 24px; font-weight: bold; display: block; }

        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold; text-transform: uppercase; }
        .bg-red { background: #e74c3c; }
        .bg-green { background: #27ae60; }
        .bg-blue { background: #3498db; }
    </style>
</head>
<body>

<div id="sidebar-left">
    <div class="header">
        <h3 style="margin:0">DANH SÁCH DỰ ÁN</h3>
    </div>
    <div style="padding:10px;"><input type="text" id="searchInp" placeholder="Tìm nhanh..." style="width:100%; padding:8px;" onkeyup="applyFilters()"></div>
    <div id="project-list" style="overflow-y:auto"></div>
</div>

<div id="map"></div>

<div id="sidebar-right">
    <div class="stat-card">
        <span id="count-display" class="stat-num">0</span>
        <small>DỰ ÁN PHÙ HỢP</small>
    </div>

    <div class="filter-section">
        <span class="filter-title"><i class="fas fa-filter"></i> QUY MÔ CĂN</span>
        <select id="f-size" onchange="applyFilters()">
            <option value="all">Tất cả quy mô</option>
            <option value="lon">Lớn (> 2000 căn)</option>
            <option value="vua">Vừa (500 - 2000 căn)</option>
            <option value="nho">Nhỏ (< 500 căn)</option>
        </select>
    </div>

    <div class="filter-section">
        <span class="filter-title"><i class="fas fa-gem"></i> PHÂN CẤP HÀNG</span>
        <select id="f-class" onchange="applyFilters()">
            <option value="all">Tất cả phân khúc</option>
            <option value="cao">Cao cấp (Vinhomes, Ecopark...)</option>
            <option value="trung">Trung cấp</option>
            <option value="thuong">Thường / NOXH</option>
        </select>
    </div>

    <div class="filter-section">
        <span class="filter-title"><i class="fas fa-sync"></i> TÌNH TRẠNG</span>
        <select id="f-status" onchange="applyFilters()">
            <option value="all">Tất cả tình trạng</option>
            <option value="Hoàn thiện">Đã hoàn thiện</option>
            <option value="xây dựng">Đang xây dựng</option>
            <option value="duyệt">Đã duyệt hồ sơ / Móng</option>
        </select>
    </div>
    
    <button onclick="resetFilters()" style="padding:10px; cursor:pointer; background:#ddd; border:none; border-radius:5px;">Xóa tất cả bộ lọc</button>
</div>

<script>
    const showroomPos = [21.048766, 105.922618];
    const map = L.map('map').setView(showroomPos, 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Tổng kho & Vòng 30km
    L.marker(showroomPos).addTo(map).bindPopup("<b>TỔNG KHO PHÚC LỢI</b>").openPopup();
    L.circle(showroomPos, { radius: 30000, color: 'blue', fillOpacity: 0.05, weight: 1, dashArray: '5,5' }).addTo(map);

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTm4CIyq3bdl3fQVwExPHPWqmn5CRNneBIbIqXM4INkiWpNDEToP9-DOvrxmgzLWEK5WiGtfmrVZSh3/pub?gid=0&single=true&output=csv';
    
    let allData = [];
    let markersLayer = L.layerGroup().addTo(map);

    function init() {
        Papa.parse(csvUrl, {
            download: true, header: true,
            complete: function(res) {
                allData = res.data.filter(p => p.vĩ_độ && p.kinh_độ);
                applyFilters();
            }
        });
    }

    function applyFilters() {
        const sizeF = document.getElementById('f-size').value;
        const classF = document.getElementById('f-class').value;
        const statusF = document.getElementById('f-status').value;
        const searchF = document.getElementById('searchInp').value.toLowerCase();

        const filtered = allData.filter(p => {
            const num = parseInt(p.quy_mo_can.replace(/,/g,'')) || 0;
            const name = p.tên_du_an.toLowerCase();
            const cdt = p.chu_dau_tu.toLowerCase();

            // Lọc Quy mô
            let mSize = true;
            if(sizeF === 'lon') mSize = num > 2000;
            if(sizeF === 'vua') mSize = num >= 500 && num <= 2000;
            if(sizeF === 'nho') mSize = num < 500;

            // Lọc Phân cấp (Logic dựa trên tên hoặc CĐT)
            let mClass = true;
            const isHigh = name.includes('vinhomes') || name.includes('ecopark') || name.includes('diamond') || name.includes('sunshine') || name.includes('heritage');
            const isNormal = name.includes('noxh') || name.includes('mường thanh') || name.includes('thanh hà');
            if(classF === 'cao') mClass = isHigh;
            if(classF === 'thuong') mClass = isNormal;
            if(classF === 'trung') mClass = !isHigh && !isNormal;

            // Lọc Tình trạng
            const mStatus = statusF === 'all' || p.tinh_trang.toLowerCase().includes(statusF.toLowerCase());
            
            // Lọc Tìm kiếm
            const mSearch = name.includes(searchF) || cdt.includes(searchF);

            return mSize && mClass && mStatus && mSearch;
        });

        renderUI(filtered);
    }

    function renderUI(data) {
        markersLayer.clearLayers();
        const list = document.getElementById('project-list');
        list.innerHTML = "";
        document.getElementById('count-display').innerText = data.length;

        data.forEach(p => {
            const lat = parseFloat(p.vĩ_độ);
            const lon = parseFloat(p.kinh_độ);
            const color = p.tinh_trang.includes("xây dựng") ? "#e74c3c" : (p.tinh_trang.includes("duyệt") ? "#3498db" : "#27ae60");

            // Vẽ lên bản đồ
            const marker = L.circleMarker([lat, lon], { radius: 8, fillColor: color, color: "#fff", weight: 2, fillOpacity: 0.8 }).addTo(markersLayer);
            marker.bindPopup(`<b>${p.tên_du_an}</b><br>CĐT: ${p.chu_dau_tu}`);

            // Thêm vào list trái
            const card = document.createElement('div');
            card.className = 'project-card';
            card.innerHTML = `
                <b style="color:var(--pana-blue)">${p.tên_du_an}</b> <span style="float:right">${p.khoang_cach}</span><br>
                <small>CĐT: ${p.chu_dau_tu} | Căn: ${p.quy_mo_can}</small><br>
                <span class="badge" style="background:${color}">${p.tinh_trang}</span>
            `;
            card.onclick = () => { map.flyTo([lat, lon], 15); marker.openPopup(); };
            list.appendChild(card);
        });
    }

    function resetFilters() {
        document.getElementById('f-size').value = 'all';
        document.getElementById('f-class').value = 'all';
        document.getElementById('f-status').value = 'all';
        document.getElementById('searchInp').value = '';
        applyFilters();
    }

    window.onload = init;
</script>
</body>
</html>
