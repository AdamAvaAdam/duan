<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Panasonic Ph√∫c L·ª£i - H·ªá Th·ªëng ƒêi·ªÅu H√†nh V14</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --pana-blue: #005696; --pana-red: #e60012; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; }
        #login-overlay { position: fixed; inset: 0; background: var(--pana-blue); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        #main-content { display: flex; width: 100%; height: 100%; filter: blur(15px); pointer-events: none; }
        #sidebar-left { flex: 0 0 380px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        #sidebar-right { flex: 0 0 320px; background: #fff; border-left: 1px solid #ddd; padding: 15px; overflow-y: auto; }
        #map { flex: 1; }
        .header { background: var(--pana-blue); color: white; padding: 15px; text-align: center; }
        .stat-box { background: var(--pana-blue); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
        .report-table { width: 100%; font-size: 13px; border-collapse: collapse; margin-bottom: 15px; }
        .report-table th { background: #f4f4f4; padding: 8px; text-align: left; border-bottom: 2px solid var(--pana-blue); }
        .report-table td { padding: 6px 10px; border-bottom: 1px solid #eee; }
        .val { font-weight: bold; color: var(--pana-red); text-align: right; }
        .project-card { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; border-left: 4px solid #ddd; transition: 0.2s; }
        .project-card:hover { background: #f0f7ff; }
        .addr-text { font-size: 11px; color: #666; margin-top: 3px; display: block; }
        .badge { display: inline-block; padding: 3px 7px; border-radius: 4px; color: white; font-size: 10px; font-weight: bold; margin-top: 5px; margin-right: 5px; }
        .bg-red { background: var(--pana-red); }
        .bg-green { background: #27ae60; }
        .bg-gold { background: #f1c40f; color: #000; } /* Cho ph√¢n c·∫•p Cao c·∫•p */
        .filter-group { margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 5px; border: 1px solid #eee; }
        .filter-group label { font-size: 11px; font-weight: bold; color: #666; text-transform: uppercase; }
        select, input { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b7/Panasonic_logo_%28Blue%29.svg" width="180">
        <h2 style="color:var(--pana-blue)">H·ªá Th·ªëng Ph√¢n T√≠ch D·ª± √Ån</h2>
        <input type="password" id="passInput" placeholder="M·∫≠t kh·∫©u: HA5566">
        <button onclick="checkLogin()" style="width:100%; padding:12px; background:var(--pana-red); color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; margin-top:10px;">X√ÅC NH·∫¨N</button>
    </div>
</div>

<div id="main-content">
    <div id="sidebar-left">
        <div class="header"><h3 style="margin:0">DANH S√ÅCH D·ª∞ √ÅN</h3></div>
        <div style="padding:10px;"><input type="text" id="searchInp" placeholder="T√¨m t√™n, ƒë·ªãa ch·ªâ, CƒêT..." onkeyup="applyFilters()"></div>
        <div id="project-list" style="overflow-y:auto; flex-grow: 1;"></div>
    </div>
    <div id="map"></div>
    <div id="sidebar-right">
        <div class="stat-box">
            <div style="font-size:28px; font-weight:bold;" id="total-match">0</div>
            <small>D·ª∞ √ÅN PH√ô H·ª¢P</small>
        </div>

        <div class="filter-group">
            <label>PH√ÇN C·∫§P D·ª∞ √ÅN</label>
            <select id="f-class" onchange="applyFilters()">
                <option value="all">T·∫•t c·∫£ ph√¢n c·∫•p</option>
                <option value="Cao c·∫•p">Cao c·∫•p</option>
                <option value="Trung c·∫•p">Trung c·∫•p</option>
                <option value="B√¨nh d√¢n">B√¨nh d√¢n/NOXH</option>
            </select>
        </div>

        <div class="filter-group">
            <label>QUY M√î CƒÇN</label>
            <select id="f-size" onchange="applyFilters()">
                <option value="all">T·∫•t c·∫£ quy m√¥</option>
                <option value="lon">L·ªõn (‚â• 2.000)</option>
                <option value="vua">V·ª´a (500-1.999)</option>
                <option value="nho">Nh·ªè (< 500)</option>
            </select>
        </div>

        <div class="filter-group">
            <label>TI·∫æN ƒê·ªò TH·ª∞C T·∫æ</label>
            <select id="f-status" onchange="applyFilters()">
                <option value="all">T·∫•t c·∫£ ti·∫øn ƒë·ªô</option>
                <option value="x√¢y d·ª±ng">ƒêang thi c√¥ng</option>
                <option value="ho√†n thi·ªán">ƒê√£ b√†n giao</option>
            </select>
        </div>

        <button onclick="resetFilters()" style="width:100%; padding:10px; margin-top:10px; cursor:pointer; background:#eee; border:1px solid #ccc; font-weight:bold;">X√ìA T·∫§T C·∫¢ B·ªò L·ªåC</button>
        
        <table class="report-table" style="margin-top:20px;">
            <thead><tr><th colspan="2">TH·ªêNG K√ä TH·ªä TR∆Ø·ªúNG</th></tr></thead>
            <tbody id="global-stats-body"></tbody>
        </table>
    </div>
</div>

<script>
    const SECRET = "HA5566";
    function checkLogin() {
        if(document.getElementById('passInput').value === SECRET) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-content').style.filter = 'none';
            document.getElementById('main-content').style.pointerEvents = 'auto';
            initMap();
        } else { alert("M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!"); }
    }

    const showroomPos = [21.048766, 105.922618];
    let map, markersLayer, allData = [];

    function initMap() {
        map = L.map('map').setView(showroomPos, 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        markersLayer = L.layerGroup().addTo(map);
        loadData();
    }

    function getCleanNum(val) {
        if (!val) return 0;
        let s = val.toString().replace(/\./g, '').replace(/,/g, ''); 
        return parseInt(s.match(/\d+/) || 0);
    }

    function loadData() {
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTm4CIyq3bdl3fQVwExPHPWqmn5CRNneBIbIqXM4INkiWpNDEToP9-DOvrxmgzLWEK5WiGtfmrVZSh3/pub?gid=0&single=true&output=csv';
        Papa.parse(csvUrl, {
            download: true, header: true,
            complete: function(res) {
                allData = res.data.filter(p => p.vƒ©_ƒë·ªô && p.kinh_ƒë·ªô);
                updateStats();
                applyFilters();
            }
        });
    }

    function updateStats() {
        let stats = { cao:0, trung:0, thap:0 };
        allData.forEach(p => {
            const pc = (p.ph√¢n_c·∫•p || "").toLowerCase();
            if(pc.includes("cao")) stats.cao++;
            else if(pc.includes("trung")) stats.trung++;
            else stats.thap++;
        });
        document.getElementById('global-stats-body').innerHTML = `
            <tr><td>Ph√¢n kh√∫c Cao c·∫•p</td><td class="val">${stats.cao}</td></tr>
            <tr><td>Ph√¢n kh√∫c Trung c·∫•p</td><td class="val">${stats.trung}</td></tr>
            <tr><td>Ph√¢n kh√∫c B√¨nh d√¢n</td><td class="val">${stats.thap}</td></tr>
        `;
    }

    function applyFilters() {
        const classF = document.getElementById('f-class').value.toLowerCase();
        const sizeF = document.getElementById('f-size').value;
        const statusF = document.getElementById('f-status').value.toLowerCase();
        const searchF = document.getElementById('searchInp').value.toLowerCase();

        const filtered = allData.filter(p => {
            const num = getCleanNum(p.quy_mo_can);
            const name = p.t√™n_du_an.toLowerCase();
            const addr = (p.ƒë·ªãa_ch·ªâ || "").toLowerCase();
            const pc = (p.ph√¢n_c·∫•p || "").toLowerCase();
            const tt = (p.tinh_trang || "").toLowerCase();

            let mClass = (classF === 'all') || pc.includes(classF);
            let mSize = (sizeF === 'all') || (sizeF === 'lon' && num >= 2000) || (sizeF === 'vua' && num >= 500 && num < 2000) || (sizeF === 'nho' && num > 0 && num < 500);
            let mStatus = (statusF === 'all') || tt.includes(statusF);
            let mSearch = name.includes(searchF) || addr.includes(searchF);

            return mClass && mSize && mStatus && mSearch;
        });
        renderUI(filtered);
    }

    function renderUI(data) {
        markersLayer.clearLayers();
        const list = document.getElementById('project-list');
        list.innerHTML = "";
        document.getElementById('total-match').innerText = data.length;

        data.forEach(p => {
            const lat = parseFloat(p.vƒ©_ƒë·ªô), lon = parseFloat(p.kinh_ƒë·ªô);
            const pc = (p.ph√¢n_c·∫•p || "");
            const isBuild = p.tinh_trang.toLowerCase().includes("x√¢y d·ª±ng");
            const color = isBuild ? "#e60012" : "#27ae60";

            L.circleMarker([lat, lon], { radius: 9, fillColor: color, color: "#fff", weight: 2, fillOpacity: 0.9 }).addTo(markersLayer)
             .bindPopup(`<b>${p.t√™n_du_an}</b><br>ƒêC: ${p.ƒë·ªãa_ch·ªâ}<br>Ph√¢n c·∫•p: ${pc}<br>Quy m√¥: ${p.quy_mo_can} cƒÉn`);

            const card = document.createElement('div');
            card.className = 'project-card';
            card.style.borderLeftColor = pc.includes("Cao") ? "#f1c40f" : color;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <strong style="color:var(--pana-blue); font-size:14px;">${p.t√™n_du_an}</strong>
                    <span style="color:var(--pana-red); font-weight:bold; font-size:11px;">${p.khoang_cach}</span>
                </div>
                <span class="addr-text">üìç ${p.ƒë·ªãa_ch·ªâ || 'Long Bi√™n, H√† N·ªôi'}</span>
                <div style="margin-top:5px;">
                    <span class="badge ${isBuild ? 'bg-red' : 'bg-green'}">${p.tinh_trang}</span>
                    <span class="badge bg-gold">${pc}</span>
                </div>
                <div style="font-size:11px; color:#777; margin-top:5px;">CƒêT: ${p.chu_dau_tu} | Quy m√¥: ${p.quy_mo_can} cƒÉn</div>
            `;
            card.onclick = () => map.flyTo([lat, lon], 15);
            list.appendChild(card);
        });
    }

    function resetFilters() {
        document.getElementById('f-class').value = 'all';
        document.getElementById('f-size').value = 'all';
        document.getElementById('f-status').value = 'all';
        document.getElementById('searchInp').value = '';
        applyFilters();
    }
</script>
</body>
</html>
