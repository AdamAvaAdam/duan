<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Panasonic Project Management V20</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --pana-blue: #005696; --pana-red: #e60012; --bg-light: #f8f9fa; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; }
        
        #login-overlay { position: fixed; inset: 0; background: var(--pana-blue); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 30px; border-radius: 12px; text-align: center; width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        #main-content { display: flex; width: 100%; height: 100%; filter: blur(15px); pointer-events: none; }

        /* Sidebar Left */
        #sidebar-left { flex: 0 0 380px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .header { background: var(--pana-blue); color: white; padding: 15px; font-weight: bold; text-align: center; font-size: 16px; }
        .project-card { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; border-left: 5px solid transparent; }
        .project-card:hover { background: #f0f7ff; }
        .card-title { color: var(--pana-blue); font-weight: bold; font-size: 14px; display: block; margin-bottom: 3px; }
        
        #map { flex: 1; z-index: 1; }

        /* Sidebar Right */
        #sidebar-right { flex: 0 0 320px; background: var(--bg-light); border-left: 1px solid #ddd; padding: 15px; overflow-y: auto; }
        .stat-group { background: white; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 12px; overflow: hidden; }
        .stat-header { background: #eee; padding: 8px 12px; font-size: 11px; font-weight: bold; color: #666; border-bottom: 1px solid #ddd; text-transform: uppercase; }
        .stat-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .stat-table tr { cursor: pointer; transition: 0.2s; }
        .stat-table tr:hover { background: #eef6ff; }
        .active-filter { background: var(--pana-blue) !important; color: white !important; }
        .active-filter .stat-count { color: white !important; }
        .stat-table td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; }
        .stat-count { text-align: right; font-weight: bold; color: var(--pana-blue); }

        /* Tags */
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; color: white; margin-top: 5px; margin-right: 4px; font-weight: bold; }
        .bg-red { background: var(--pana-red); }
        .bg-green { background: #2ecc71; }
        .bg-gold { background: #f1c40f; color: #000; }
        .bg-blue { background: #3498db; }
        .bg-grey { background: #95a5a6; }
        .bg-purple { background: #9b59b6; }
        .bg-orange { background: #e67e22; }
        .bg-teal { background: #16a085; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b7/Panasonic_logo_%28Blue%29.svg" width="150" style="margin-bottom:20px">
        <input type="password" id="passInput" placeholder="M·∫≠t kh·∫©u: HA5566" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
        <button onclick="checkLogin()" style="width:100%; padding:12px; background:var(--pana-red); color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">ƒêƒÇNG NH·∫¨P</button>
    </div>
</div>

<div id="main-content">
    <div id="sidebar-left">
        <div class="header">DANH S√ÅCH D·ª∞ √ÅN MI·ªÄN B·∫ÆC</div>
        <div style="padding:10px;"><input type="text" id="searchInp" placeholder="T√¨m theo t√™n, ƒë·ªãa ch·ªâ, CƒêT..." onkeyup="applyFilters()" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:5px; box-sizing:border-box;"></div>
        <div id="project-list" style="overflow-y:auto; flex: 1;"></div>
    </div>
    
    <div id="map"></div>

    <div id="sidebar-right">
        <div class="header" style="border-radius:8px; margin-bottom:10px">B√ÅO C√ÅO NHANH</div>
        
        <div class="stat-group">
            <div class="stat-header">QUY M√î D·ª∞ √ÅN</div>
            <table class="stat-table">
                <tr onclick="setQuickFilter('size', 'lon', this)"><td>D·ª± √°n L·ªõn (‚â• 2.000 cƒÉn)</td><td id="size-l" class="stat-count">0</td></tr>
                <tr onclick="setQuickFilter('size', 'vua', this)"><td>D·ª± √°n V·ª´a (500-1.999)</td><td id="size-m" class="stat-count">0</td></tr>
                <tr onclick="setQuickFilter('size', 'nho', this)"><td>D·ª± √°n Nh·ªè (< 500)</td><td id="size-s" class="stat-count">0</td></tr>
            </table>
        </div>

        <div class="stat-group">
            <div class="stat-header">PH√ÇN C·∫§P S·∫¢N PH·∫®M</div>
            <table class="stat-table">
                <tr onclick="setQuickFilter('class', 'cao', this)"><td>Cao c·∫•p</td><td id="class-high" class="stat-count">0</td></tr>
                <tr onclick="setQuickFilter('class', 'trung', this)"><td>Trung c·∫•p</td><td id="class-mid" class="stat-count">0</td></tr>
                <tr onclick="setQuickFilter('class', 'b√¨nh', this)"><td>B√¨nh d√¢n/NOXH</td><td id="class-low" class="stat-count">0</td></tr>
            </table>
        </div>

        <div class="stat-group">
            <div class="stat-header">T√åNH TR·∫†NG THI C√îNG</div>
            <table class="stat-table">
                <tr onclick="setQuickFilter('status', 'ƒëang', this)"><td>ƒêang x√¢y d·ª±ng</td><td id="status-doing" class="stat-count">0</td></tr>
                <tr onclick="setQuickFilter('status', 'ƒë√£', this)"><td>ƒê√£ ho√†n thi·ªán</td><td id="status-done" class="stat-count">0</td></tr>
            </table>
        </div>

        <button onclick="resetFilters()" style="width:100%; padding:10px; cursor:pointer; background:var(--pana-blue); color:white; border:none; border-radius:5px; font-weight:bold;">HI·ªÜN T·∫§T C·∫¢ D·ª∞ √ÅN</button>
    </div>
</div>

<script>
    const SECRET = "HA5566";
    const HUB_POS = [21.048766, 105.922618];
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTm4CIyq3bdl3fQVwExPHPWqmn5CRNneBIbIqXM4INkiWpNDEToP9-DOvrxmgzLWEK5WiGtfmrVZSh3/pub?gid=0&single=true&output=csv';
    
    let map, markersLayer, allData = [];
    let currentFilter = { type: 'all', value: '' };

    function checkLogin() {
        if(document.getElementById('passInput').value === SECRET) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-content').style.filter = 'none';
            document.getElementById('main-content').style.pointerEvents = 'auto';
            initApp();
        } else { alert("Sai m·∫≠t kh·∫©u!"); }
    }

    function initApp() {
        map = L.map('map').setView(HUB_POS, 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        markersLayer = L.layerGroup().addTo(map);

        L.marker(HUB_POS, {
            icon: L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:#005696; color:white; padding:5px 10px; border-radius:5px; border:2px solid white; font-weight:bold; white-space:nowrap;'>KHO PH√öC L·ª¢I (HUB)</div>",
                iconSize: [140, 30], iconAnchor: [70, 15]
            })
        }).addTo(map);

        [10, 30, 50, 70, 100].forEach(km => {
            L.circle(HUB_POS, { radius: km * 1000, color: '#005696', fillOpacity: 0.01, weight: 1, dashArray: '8, 8' }).addTo(map);
        });

        loadData();
    }

    function getCleanNum(val) {
        if (!val) return 0;
        return parseInt(val.toString().replace(/\D/g, '')) || 0;
    }

    // H√ÄM CH·ªàNH S·ª¨A: ∆Øu ti√™n l·∫•y d·ªØ li·ªáu t·ª´ c·ªôt Ph√¢n C·∫•p (C·ªôt K)
    function detectClass(p) {
        // L√†m s·∫°ch key ƒë·ªÉ t√¨m ƒë√∫ng c·ªôt Ph√¢n c·∫•p b·∫•t k·ªÉ vi·∫øt hoa/th∆∞·ªùng/c√≥ d·∫•u
        let rawClass = p.ph√¢n_c·∫•p || p.phancap || p.Phan_cap || "";
        let classValue = rawClass.toString().trim();

        if (classValue !== "") {
            return classValue; // N·∫øu c·ªôt K c√≥ d·ªØ li·ªáu, l·∫•y lu√¥n gi√° tr·ªã ƒë√≥
        }

        // N·∫øu c·ªôt K tr·ªëng, m·ªõi d√πng logic ƒëo√°n t·ª´ kh√≥a c≈©
        let text = (p.t√™n_du_an || "").toLowerCase();
        if (text.includes("cao") || text.includes("vip") || text.includes("sang")) return "Cao c·∫•p";
        if (text.includes("b√¨nh") || text.includes("noxh") || text.includes("r·∫ª")) return "B√¨nh d√¢n";
        return "Trung c·∫•p";
    }

    function loadData() {
        Papa.parse(csvUrl, {
            download: true, header: true,
            complete: function(res) {
                // T·ª± ƒë·ªông chu·∫©n h√≥a t√™n c·ªôt ƒë·ªÉ d·ªÖ truy c·∫≠p
                allData = res.data.filter(p => p.vƒ©_ƒë·ªô && p.kinh_ƒë·ªô).map(p => {
                    // G·ªçi h√†m detectClass ƒë√£ s·ª≠a ƒë·ªïi
                    p.pClass = detectClass(p);
                    
                    let q = getCleanNum(p.quy_mo_can || p.quymocan);
                    p.pSize = (q >= 2000) ? "L·ªõn" : (q >= 500 ? "V·ª´a" : "Nh·ªè");
                    return p;
                });
                updateStats(allData);
                applyFilters();
            }
        });
    }

    function updateStats(data) {
        let s = { l:0, m:0, sn:0, high:0, mid:0, low:0, doing:0, done:0 };
        data.forEach(p => {
            if(p.pSize === "L·ªõn") s.l++; else if(p.pSize === "V·ª´a") s.m++; else s.sn++;
            
            // Th·ªëng k√™ d·ª±a tr√™n c·ªôt Ph√¢n c·∫•p m·ªõi
            let pc = p.pClass.toLowerCase();
            if(pc.includes("cao")) s.high++; 
            else if(pc.includes("b√¨nh") || pc.includes("th·∫•p")) s.low++; 
            else s.mid++;

            let tt = (p.tinh_trang || p.tinhtrang || "").toLowerCase();
            if(tt.includes("ƒëang") || tt.includes("x√¢y")) s.doing++; else s.done++;
        });
        document.getElementById('size-l').innerText = s.l;
        document.getElementById('size-m').innerText = s.m;
        document.getElementById('size-s').innerText = s.sn;
        document.getElementById('class-high').innerText = s.high;
        document.getElementById('class-mid').innerText = s.mid;
        document.getElementById('class-low').innerText = s.low;
        document.getElementById('status-doing').innerText = s.doing;
        document.getElementById('status-done').innerText = s.done;
    }

    function setQuickFilter(type, val, el) {
        document.querySelectorAll('.stat-table tr').forEach(tr => tr.classList.remove('active-filter'));
        el.classList.add('active-filter');
        currentFilter = { type: type, value: val };
        applyFilters();
    }

    function applyFilters() {
        const search = document.getElementById('searchInp').value.toLowerCase();
        const filtered = allData.filter(p => {
            const matchSearch = p.t√™n_du_an.toLowerCase().includes(search) || (p.ƒë·ªãa_ch·ªâ || "").toLowerCase().includes(search);
            let matchQuick = true;
            if (currentFilter.type === 'size') {
                matchQuick = p.pSize.toLowerCase().startsWith(currentFilter.value[0]);
            } else if (currentFilter.type === 'class') {
                matchQuick = p.pClass.toLowerCase().includes(currentFilter.value);
            } else if (currentFilter.type === 'status') {
                matchQuick = (p.tinh_trang || p.tinhtrang || "").toLowerCase().includes(currentFilter.value);
            }
            return matchSearch && matchQuick;
        });
        renderUI(filtered);
    }

    function renderUI(data) {
        markersLayer.clearLayers();
        const list = document.getElementById('project-list');
        list.innerHTML = "";
        data.forEach(p => {
            const lat = parseFloat(p.vƒ©_ƒë·ªô), lon = parseFloat(p.kinh_ƒë·ªô);
            const isDoing = (p.tinh_trang || p.tinhtrang || "").toLowerCase().includes("ƒëang");
            const color = isDoing ? "#e60012" : "#2ecc71";
            
            // Hi·ªÉn th·ªã Tag Ph√¢n C·∫•p tr·ª±c quan
            const pc = p.pClass.toLowerCase();
            const classColor = pc.includes("cao") ? "bg-gold" : (pc.includes("b√¨nh") ? "bg-grey" : "bg-blue");
            const sizeColor = p.pSize === "L·ªõn" ? "bg-purple" : (p.pSize === "V·ª´a" ? "bg-orange" : "bg-teal");

            L.circleMarker([lat, lon], { radius: 8, fillColor: color, color: "#fff", weight: 2, fillOpacity: 0.8 }).addTo(markersLayer)
             .bindPopup(`<b>${p.t√™n_du_an}</b><br>Quy m√¥: ${p.pSize}<br>Ph√¢n c·∫•p: ${p.pClass}<br>CƒêT: ${p.ch·ªß_ƒë·∫ßu_t∆∞ || 'N/A'}`);

            const card = document.createElement('div');
            card.className = 'project-card';
            card.style.borderLeftColor = color;
            card.innerHTML = `
                <span class="card-title">${p.t√™n_du_an}</span>
                <div style="font-size:11px; color:#555;">
                    üìç ${p.ƒë·ªãa_ch·ªâ || 'N/A'} | <b>${p.kho·∫£ng_c√°ch || p.khoang_cach || '0'} km</b><br>
                    üì¶ S·ªë cƒÉn: <b style="color:var(--pana-red)">${p.quy_mo_can || p.quymocan || '0'}</b>
                </div>
                <div style="margin-top:2px;">
                    <span class="badge ${sizeColor}">Quy m√¥: ${p.pSize}</span>
                    <span class="badge ${classColor}">${p.pClass}</span>
                    <span class="badge ${isDoing ? 'bg-red' : 'bg-green'}">${p.tinh_trang || p.tinhtrang}</span>
                </div>
            `;
            card.onclick = () => map.flyTo([lat, lon], 14);
            list.appendChild(card);
        });
    }

    function resetFilters() {
        document.querySelectorAll('.stat-table tr').forEach(tr => tr.classList.remove('active-filter'));
        document.getElementById('searchInp').value = "";
        currentFilter = { type: 'all', value: '' };
        applyFilters();
    }
</script>
</body>
</html>

